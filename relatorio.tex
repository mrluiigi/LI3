\documentclass[10pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[portuguese]{babel}
\usepackage{a4wide}
\usepackage{listings}


\title{Projeto de Laboratórios de Informática 3\\Grupo 26}
\author{José Pinto (A81317) \and Luís Correia (A81141) \and Pedro Barbosa (A82068)}
\date{\today}

\begin{document}

\maketitle

\begin{abstract}
  Neste projeto da disciplina de Laboratórios de Informática 3 (LI3) do Mestrado Integrado em Engenharia Informática da Universidade do Minho foi-nos proposto desenvolver um sistema em C capaz de processar ficheiros XML que armazenam informações utilizadas pelo Stack Overflow, podendo depois executar um conjunto de querys de forma eficiente.
\end{abstract}

\tableofcontents

\section{Introdução}
\label{sec:intro}

Neste relatório vamos primeiramente falar das estruturas de dados utilizadas e dos vários módulos criados, terminando com a explicação das estratégias usadas em cada query.  

\section{Dependências externas}
\label{sec:dependencias}

Este projeto tem duas dependências externas, as bibliotecas libxml2 e glib.

\section{Módulos}
\label{sec:modulos}

Nesta secção vamos falar dos módulos criados para auxiliar o desenvolvimento deste projeto.

\subsection{Post}

	Este módulo corresponde à implementação de um post do Stack Overflow.
\subsubsection{Estrutura de dados}
	A informacão relativa a um utilizador é guardada na estrutura \emph{post}:
	\begin{lstlisting}
	struct post {
		//Identifica o tipo de post (Pergunta ou Resposta)
		char postTypeId;
		QUESTION q; 
		ANSWER a; 
		//ID do post 
		int id;
		//ID do utilizador que fez o post 
		char * ownerUserId;
		//Data da criacao do post 
		Date creationDate;
	};
	\end{lstlisting}
	Esta estrutura é a implementação concreta do tipo de dados abstrato POST declarado no header:
	\begin{lstlisting} 
	typedef struct post * POST;
	\end{lstlisting}

	Como a informação de um post varia conforme seja uma pergunta ou uma resposta, foram criadas as estrututras QUESTION e ANSWER:
\begin{lstlisting}
	typedef struct question{
		//Titulo
		char *title;
		//Numero de respostas 
		int nanswers;
		//Tags 
		GSList *tags;
		//Ultima atividade do post 
		Date lastActivityDate;
	}*QUESTION;
	\end{lstlisting}
	\begin{lstlisting}
	typedef struct answer{
		// ParentID (ID do post a que a resposta pertence) 
		int parentId;
		// Numero de comentarios de uma resposta 
		int comments;
		// Score de uma resposta 
		int score;
	}*ANSWER;
	\end{lstlisting}

	O membro \emph{tags} é uma lista ligada que guarda os ids das tags de um post.

\subsubsection{Funções}

	Devido à dicotomia dos posts, existem duas funções distintas para a criação de uma instância de um POST. Estas criam c
	ópias de todos parâmetros recebidos com tipo não primitivo, para garantir o encapsulamento dos dados.

	O acesso exterior aos membros da estrutura é realizado exclusivamente através de funções. Todas as variáveis podem ser consultadas, sendo o resultado da consulta de tipos não primitivos uma cópia destes. Nenhum membro da estrutura pode ser alterado após a iniciaização.

	Existe também uma função que liberta a memória alocada para a estrutura.

\subsection{Posts}
	O objetivo deste módulo é permitir guardar e processar a informação de todos os posts de uma comunidade do Stack Overflow
\subsubsection{Estrutura de dados}

	A estrutura utilizada é \emph{TCD\_posts}:
	\begin{lstlisting}
	struct TCD_posts {
		GSList *list;
		GHashTable *hash;
		GHashTable *months_hash; 
};
	\end{lstlisting}

	O membro \emph{list} é uma lista ligada que contêm todos os posts por ordem cronológica inversa. \emph{hash} é uma hashtable que associa o id de um \emph{POST} à posicão deste na lista. \emph{months\_hash} é uma hashtable que faz a associação entre um mês(e o ano) e o primeiro post desse mês. Assim, quando um dos parâmetros de uma interrogação é um intervalo de tempo, é possível começar a percorrer a lista dos posts num ponto já muito próximo do intervalo pedido, evitando percorrer a lista desnecessariamente. Desta forma o tempo de execução dessas interrogações é muito menor. Poderíamos ter optador por guardar o primeiro post de cada dia no entanto a melhoria no tempo de execução não compensaria o tamanho acrescido da hashtable. 

	Esta estrutura é a implementação concreta do tipo de dados abstrato \emph{Posts} declarado no header:
	\begin{lstlisting} 
	typedef struct TCD_posts * Posts;
	\end{lstlisting}

	Como é necessário percorrer a lista dos posts em várias interrogações também foi definido o tipo \emph{PostsList} para manter a abstração:
	\begin{lstlisting} 
	typedef GSList * PostsList;
	\end{lstlisting}

\subsubsection{Funções}	
	
	Depois de uma instância de \emph{Posts} ser incializada com \emph{init\_posts}, podem ser utilizadas funções para adicionar/remover posts. Tal como no módulo anterior existe uma função de adição para as perguntas e outras para as respostas. Estas funções recebem a informação através de vários parâmetros e usam internamente as funções do módulo Post para assegurar o encapsulamento.

	Para garantir o correto funcionamento do módulo é necessário que o a função \emph{finalize\_posts} seja invocada após todos os posts serem adicionados. O bom funcionamento do módulo estar dependente de um fator externo pode não ser ideal mas foi um compromisso realizado para garantir um tempo de execução aceitável. É mais eficiente ordenar a \emph{list} e preencher a \emph{months\_hash} depois de todos os posts serem inseridos.

	Existem várias funções que permitem procurar um post, ou a localização deste na lista, de acordo com certos parâmetros (id, data, etc). Também existem funções que permitem percorrer a lista de posts e obter o \emph{POST} dessa posição. Como estas últimas funções recebem/devolvem o tipo abstrato \emph{PostsList} o encapsulamento é garantido.

	Também está definida uma função para libertar a memória alocada.

\subsection{MyUser}
	Este módulo corresponde à implementação de um utilizador do Stack Overflow, contendo do  guarda a informação relativa a um \emph{user}. 
\subsubsection{Estrutura de dados}
	
	A informacão relativa a um utilizador é guardada na estrutura \emph{user\_ht}:
	\begin{lstlisting}
	struct user_ht{
		//ID do user 
		int id;
		//Nome do utilizador 
		char *name;
		// ShortBio do utilizador 
		char *shortBio;
		// Numero de posts do utilizador 
		unsigned short nr_posts;
		// Ultimo post do utilizador 
		int lastPost;
		// Reputacao do utilizador 
		int reputation;
	};
	\end{lstlisting}


	O último post do utilizador corresponde ao id do post mais recente deste e a sua utilidade será esclarecida na secção sobre a interrogação 5. Os restantes membros da estrutura contêm informação necessária para responder às interrogações.

	Esta estrutura é a implementação concreta do tipo de dados abstrato MY\_USER declarado no header:
	\begin{lstlisting} 
	typedef struct user_ht * MY_USER;
	\end{lstlisting}

\subsubsection{Funções}

	A criação de uma instância do MY\_USER é feita através de um método de construção parametrizado. Esta função tem o cuidado de criar cópias das strings recebidas para garantir o encapsulmanento dos dados.

	O acesso exterior aos membros da estrutura é realizado exclusivamente através de funções. Todos as variáveis podem ser consultadas, sendo o resultado da consulta de tipos não primitivos uma cópia destes. As únicas que podem ser modificadas após a inicialização são o \emph{lastPost} e o \emph{nr\_posts} devido ao facto de que a informação destes não se encontrar no ficheiro Users.xml e ser obtida através do posterior processamento do ficheiro Posts.xml

	Por último, existe uma função que liberta a memória alocada para a estrutura.

\subsection{Users}
	O objetivo deste módulo é permitir guardar e processar a informação de todos os utilizadores de uma comunidade do Stack Overflow
\subsubsection{Estrutura de dados}

	A estrutura utilizada é \emph{users}:
	\begin{lstlisting}
	struct users {
		GHashTable* hash;
		GSList* users_by_nr_posts;
		GSList* users_by_reputation;
	};
	\end{lstlisting}

	\emph{hash} é uma hashtable que associa o id a um \emph{USER}. \emph{users\_by\_nr\_posts} e \emph{users\_by\_nr\_reputation} são listas ligadas de \emph{USER}, ordenadas em ordem decrescente de acordo com o número de posts e a reputação de cada \emph{USER}.

	Esta estrutura é a implementação concreta do tipo de dados abstrato MY\_USER declarado no header:
	\begin{lstlisting} 
	typedef struct users * USERS;
	\end{lstlisting}

\subsubsection{Funções}
	Tal como no módulo \emph{Posts}, depois de uma instância de \emph{Users} ser incializada com \emph{init\_users}, podem ser utilizadas funções para adicionar/remover posts. A função de adição recebe a informação através de vários parâmetros e usam internamente as funções do módulo User para assegurar o encapsulamento.

	Existem duas funções para alterar o número de posts e o último post de um dado utlilizador. Assim, é possível percorrer a lista de posts contida numa instância de \emph{Posts} para alterar estas variáveis mesmo após as instâncias de \emph{USER} já terem sido criadas.

	Por razões semelhantes às explicadas no módulo \emph{Posts} (neste caso é a ordenção das duas listas), é necessário que o a função \emph{finalize\_users} seja invocada após todos os utilizadores serem adicionados/alterados.

	A funcionalidade principal deste módulo é a função \emph{find\_user}, que permite obter a informação de um utilizador dado o seu id, e duas funçõesque percorrem uma das listas da estrura \emph{users} e criam e retornam uma \emph{LONG\_list} com os N utilizadores com mais posts ou mais reputação.

	Também está definida uma função para libertar a memória alocada.

\subsection{My Date}

	O módulo \emph{mydate} é um pequeno módulo que possui algumas funções relacionadas com datas que são utlilizadas por vários módulos. 

\subsection{Tags}
	Este módulo é responsável por guardar e processar informação sobre tags de posts
\subsubsection{Estrutura de dados}
	A estrutura de dados deste módulo é apenas uma hash table que associa o nome de uma tag ao seu id. Para o propóśito da abstração esta tabela é representada pelo tipo \emph{TAGS}:
	\begin{lstlisting} 
	typedef GHashTable * TAGS;
	\end{lstlisting}

\subsubsection{Funções}
	As únicas funções presentes neste módulo são as de inicialização, inserção, procura e libertação de memória. Existe apenas mais uma função utilizada para converter a informação sobre tags presente no Posts.xml numa lista para passar à função \emph{create\_question} do módulo \emph{Post}

\end{document}